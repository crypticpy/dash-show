<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Data Visualization Dashboard Showcase</title>
    <meta
      name="description"
      content="Curated showcase of municipal CIP, Power BI reports, and visualization patterns for project prioritization and ranking."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0f1115;
        --fg: #e8eaed;
        --muted: #9aa0a6;
        --card: #171a21;
        --card-2: #1b1f2a;
        --accent: #3b82f6;
        --accent-2: #22c55e;
        --accent-3: #8b5cf6;
        --border: #283042;
        --chip: #22314b;
        --chip-fg: #dbe8ff;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --shadow-hover: 0 20px 50px rgba(59, 130, 246, 0.15);
        --radius: 16px;
        --radius-sm: 12px;
        --radius-xs: 8px;
        --gap: 20px;
        --card-padding: 16px;
        --maxw: 1200px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f8fb;
          --fg: #1f2937;
          --muted: #4b5563;
          --card: #ffffff;
          --card-2: #f3f6fb;
          --accent: #2563eb;
          --accent-2: #16a34a;
          --accent-3: #8b5cf6;
          --border: #e5e7eb;
          --chip: #e8f0ff;
          --chip-fg: #1e40af;
          --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
          --shadow-hover: 0 16px 40px rgba(37, 99, 235, 0.12);
        }
        .subtitle {
          background: rgba(255, 255, 255, 0.92);
          border-color: rgba(37, 99, 235, 0.25);
          box-shadow: 0 12px 28px rgba(37, 99, 235, 0.18);
          color: var(--fg);
        }
        .subtitle-detail {
          color: rgba(31, 41, 55, 0.78);
        }
        .detail-overlay {
          background: rgba(15, 21, 33, 0.45);
        }
        .detail-modal {
          background: rgba(255, 255, 255, 0.98);
          border-color: rgba(229, 231, 235, 0.9);
          box-shadow: 0 26px 60px rgba(37, 99, 235, 0.22);
        }
        .detail-media {
          background: rgba(243, 246, 251, 0.95);
          box-shadow: 0 16px 34px rgba(37, 99, 235, 0.16);
        }
        .detail-blurb {
          background: rgba(37, 99, 235, 0.1);
          border-color: rgba(37, 99, 235, 0.2);
          color: rgba(31, 41, 55, 0.78);
        }
        .detail-chip {
          background: rgba(255, 255, 255, 0.92);
          border-color: rgba(229, 231, 235, 0.9);
          color: var(--fg);
        }
        .detail-close {
          background: rgba(243, 246, 251, 0.92);
        }
        .detail-close:hover,
        .detail-close:focus-visible {
          background: var(--accent);
        }
        .detail-category {
          background: rgba(37, 99, 235, 0.12);
          border-color: rgba(37, 99, 235, 0.25);
        }
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 0;
        font-family:
          Inter,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        background:
          radial-gradient(
            1200px 600px at 80% -10%,
            rgba(59, 130, 246, 0.12),
            transparent 70%
          ),
          var(--bg);
        color: var(--fg);
        line-height: 1.5;
      }
      body.detail-open {
        overflow: hidden;
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: saturate(120%) blur(12px);
        background: linear-gradient(
          to bottom,
          rgba(10, 12, 16, 0.92),
          rgba(10, 12, 16, 0.88)
        );
        border-bottom: 1px solid var(--border);
        transition: var(--transition);
      }
      @media (prefers-color-scheme: light) {
        header {
          background: linear-gradient(
            to bottom,
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.85)
          );
        }
      }
      .wrap {
        max-width: var(--maxw);
        margin: 0 auto;
        padding: 18px 16px;
      }
      .hero {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .title {
        display: flex;
        align-items: center;
        gap: 14px;
        flex: 1 1 420px;
      }
      .title-text {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .logo {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: linear-gradient(
          135deg,
          var(--accent),
          var(--accent-2),
          var(--accent-3)
        );
        box-shadow: var(--shadow);
        display: grid;
        place-items: center;
        color: white;
        font-weight: 800;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
      }
      .logo::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transform: translateX(-100%);
        transition: transform 0.6s;
      }
      .logo:hover::before {
        transform: translateX(100%);
      }
      .logo span {
        font-size: 22px;
      }
      h1 {
        margin: 0;
        font-size: clamp(24px, 3.6vw, 38px);
        line-height: 1.1;
      }
      .subtitle {
        margin: 10px 0 0;
        display: inline-flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
        padding: 16px 18px;
        border-radius: var(--radius);
        background: rgba(17, 20, 27, 0.82);
        color: var(--fg);
        font-size: 15px;
        line-height: 1.55;
        border: 1px solid rgba(59, 130, 246, 0.22);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.22);
        max-width: 620px;
      }
      .subtitle-count {
        font-size: clamp(16px, 2.4vw, 20px);
        font-weight: 600;
        color: var(--accent);
        letter-spacing: 0.01em;
      }
      .subtitle-count strong {
        font-weight: 700;
        color: inherit;
      }
      .subtitle-detail {
        color: rgba(232, 234, 237, 0.92);
        font-size: 14px;
      }
      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .control {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--card);
        border: 1px solid var(--border);
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        transition: var(--transition);
      }
      .control:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      input[type="search"] {
        border: none;
        background: transparent;
        color: var(--fg);
        outline: none;
        width: 260px;
        font-size: 14px;
        transition: var(--transition);
      }
      input[type="search"]:focus {
        width: 300px;
      }
      input[type="search"]::placeholder {
        color: var(--muted);
        transition: opacity 0.3s;
      }
      input[type="search"]:focus::placeholder {
        opacity: 0.5;
      }
      select,
      button {
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--fg);
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      select:hover,
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        filter: brightness(1.05);
      }
      select:focus,
      button:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      main {
        max-width: var(--maxw);
        margin: 18px auto;
        padding: 0 16px 96px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 14px 0 6px;
      }
      .chip {
        padding: 8px 12px;
        background: var(--chip);
        color: var(--chip-fg);
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        user-select: none;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      .chip::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transform: translateX(-100%);
        transition: transform 0.4s;
      }
      .chip:hover::before {
        transform: translateX(100%);
      }
      .chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .chip[aria-pressed="true"] {
        background: linear-gradient(
          135deg,
          var(--accent),
          var(--accent-2),
          var(--accent-3)
        );
        color: white;
        border-color: transparent;
        box-shadow: 0 2px 12px rgba(59, 130, 246, 0.3);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--gap);
        margin-top: 20px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        min-height: 420px;
        transition: var(--transition);
        position: relative;
        cursor: pointer;
      }
      .card.loading .thumb {
        background: var(--card-2);
        position: relative;
        overflow: hidden;
      }
      .card.loading .thumb::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.05) 50%,
          transparent 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      .card.loading .content h3,
      .card.loading .description,
      .card.loading .technique-tag {
        background: var(--card-2);
        color: transparent;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }
      .card.loading .content h3::before,
      .card.loading .description::before,
      .card.loading .technique-tag::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.05) 50%,
          transparent 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      /* Enhanced Card Header */
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        background: var(--card-2);
      }
      .category-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 600;
        color: var(--accent-3);
        background: rgba(139, 92, 246, 0.1);
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid rgba(139, 92, 246, 0.2);
      }
      .category-badge:nth-child(1n) {
        color: var(--accent);
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.2);
      }
      .category-badge:nth-child(2n) {
        color: var(--accent-2);
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.2);
      }
      .category-badge:nth-child(3n) {
        color: var(--accent-3);
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.2);
      }
      .category-badge:nth-child(4n) {
        color: orange;
        background: rgba(251, 146, 60, 0.1);
        border-color: rgba(251, 146, 60, 0.2);
      }

      /* Enhanced Content Structure */
      .content {
        padding: var(--card-padding);
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
      }
      .content h3 {
        margin: 0;
        font-size: 16px;
        line-height: 1.3;
        color: var(--fg);
        font-weight: 600;
        scroll-margin-top: 8px;
      }
      .description {
        color: var(--fg);
        font-size: 13px;
        line-height: 1.5;
        margin: 0;
        opacity: 0.9;
        flex: 1;
      }
      .techniques {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: auto;
      }
      .technique-tag {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 4px;
        background: var(--chip);
        color: var(--chip-fg);
        border: 1px solid var(--border);
        font-weight: 500;
      }

      /* Enhanced Pattern Overlay */
      .pattern-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.7),
          rgba(0, 0, 0, 0.3)
        );
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
        padding: 8px;
        gap: 4px;
        flex-wrap: wrap;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      .technique-badge {
        font-size: 9px;
        padding: 2px 6px;
        background: rgba(255, 255, 255, 0.9);
        color: var(--bg);
        border-radius: 3px;
        font-weight: 600;
        backdrop-filter: blur(4px);
      }

      /* Enhanced Card Hover States */
      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          transparent,
          rgba(59, 130, 246, 0.05)
        );
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      .card:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: var(--shadow-hover);
        border-color: var(--accent);
      }
      .card:hover::before {
        opacity: 1;
      }
      .card:hover .pattern-overlay {
        opacity: 1;
      }
      .card:hover .thumb img {
        transform: scale(1.05);
      }
      .card:hover .technique-tag {
        background: var(--accent-2);
        color: white;
        border-color: var(--accent-2);
      }

      /* Focus States for Accessibility */
      .card:focus {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
        border-color: var(--accent);
      }
      .card:focus-within {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      /* Enhanced Actions */
      .actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding: 0 16px 16px;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 12px;
        background: var(--card-2);
        border: 1px solid var(--border);
        color: var(--fg);
        font-size: 13px;
        text-decoration: none;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        font-weight: 500;
      }
      .btn::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transform: translateX(-100%);
        transition: transform 0.4s;
      }
      .btn:hover::before {
        transform: translateX(100%);
      }
      .btn.primary {
        background: linear-gradient(
          135deg,
          var(--accent),
          var(--accent-2),
          var(--accent-3)
        );
        color: #fff;
        border: none;
      }
      .btn.primary:hover {
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        transform: translateY(-1px);
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .meta {
        margin-top: 20px;
        color: var(--muted);
        font-size: 12px;
      }
      .footer {
        border-top: 1px solid var(--border);
        padding: 32px 16px;
        color: var(--muted);
        text-align: center;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.12), transparent);
      }
      .thumb {
        position: relative;
        height: 200px;
        background: var(--card-2);
        overflow: hidden;
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        opacity: 0;
        transition:
          opacity 0.5s ease,
          transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .thumb img.loaded {
        opacity: 1;
      }
      .badge {
        position: absolute;
        left: 10px;
        top: 10px;
        font-size: 11px;
        background: rgba(0, 0, 0, 0.55);
        padding: 6px 8px;
        border-radius: 6px;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.15);
        z-index: 2;
      }
      @media (prefers-color-scheme: light) {
        .badge {
          background: rgba(0, 0, 0, 0.35);
        }
      }
      /* Remove old unused styles */
      .content {
        padding: var(--card-padding);
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }
      .title-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
        justify-content: space-between;
      }
      .card h3 {
        margin: 0;
        font-size: 16px;
        line-height: 1.25;
      }
      .domain {
        color: var(--muted);
        font-size: 12px;
      }
      .blurb {
        color: var(--fg);
        opacity: 0.9;
        font-size: 13px;
        margin-top: 4px;
      }
      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: auto;
      }
      .tag {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px dashed var(--border);
        color: var(--muted);
      }
      .actions {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .notice {
        font-size: 12px;
        color: var(--muted);
      }

      body.learning-mode {
        overflow: hidden;
      }

      @media print {
        @page {
          size: letter;
          margin: 0.75in;
        }

        body {
          background: #ffffff !important;
          color: #1f2937;
          font-size: 11pt;
        }

        body.learning-mode {
          overflow: visible;
        }

        header,
        main,
        footer,
        .hero,
        .chips,
        .grid,
        .meta,
        .notice {
          display: none !important;
        }

        .learning-overlay {
          position: static;
          inset: auto;
          padding: 0;
          background: transparent;
          display: block;
        }

        .learning-panel {
          width: 100%;
          max-height: none;
          border: none;
          border-radius: 0;
          box-shadow: none;
          backdrop-filter: none;
          color: inherit;
        }

        .learning-header {
          padding: 0 0 12pt;
          margin-bottom: 18pt;
          border: none;
          border-bottom: 2px solid currentColor;
        }

        .learning-header h3 {
          font-size: 18pt;
          letter-spacing: 0.02em;
        }

        .close-btn,
        .learning-actions {
          display: none !important;
        }

        .learning-content {
          padding: 0;
        }

        .learning-section {
          margin-bottom: 18pt;
          padding-right: 6pt;
        }

        .learning-section h4 {
          color: inherit;
          font-size: 12pt;
          text-transform: uppercase;
          letter-spacing: 0.06em;
          margin-bottom: 6pt;
        }

        .learning-section p {
          color: inherit;
          font-size: 10.5pt;
        }

        .learning-section ul {
          padding-left: 18pt;
        }

        .learning-section li {
          font-size: 10.5pt;
          margin-bottom: 8pt;
          line-height: 1.45;
        }

        .learning-section textarea {
          background: transparent;
          border: 1px solid currentColor;
          min-height: 160px;
          padding: 10pt;
          font-size: 10.5pt;
        }

        .learning-section:nth-of-type(3) {
          break-after: page;
        }

        #learningOverlay,
        #learningPanel,
        #learningPanelDescription,
        #checklistContent {
          display: block;
        }
      }

      .learning-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 72px 16px 24px;
        background: rgba(15, 17, 21, 0.65);
        z-index: 220;
        transition: opacity 0.25s ease;
      }

      @media (prefers-color-scheme: light) {
        .learning-overlay {
          background: rgba(17, 24, 39, 0.4);
        }
      }

      .learning-overlay[hidden] {
        display: none;
      }

      .learning-panel {
        width: min(420px, 100%);
        max-height: calc(100vh - 120px);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-hover);
        overflow-y: auto;
        backdrop-filter: saturate(120%) blur(12px);
        outline: none;
      }

      @media (max-width: 720px) {
        .learning-overlay {
          align-items: flex-end;
          padding: 32px 12px 24px;
        }

        .learning-panel {
          width: 100%;
          max-height: calc(100vh - 56px);
        }
      }

      .learning-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid var(--border);
      }

      .learning-header h3 {
        margin: 0;
        font-size: 16px;
        color: var(--fg);
      }

      .close-btn {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        transition: var(--transition);
      }

      .close-btn:hover,
      .close-btn:focus-visible {
        background: var(--card-2);
        color: var(--fg);
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }

      .learning-content {
        padding: 16px;
      }

      .learning-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .learning-actions .btn {
        font-size: 12px;
        padding: 8px 12px;
      }

      .learning-section {
        margin-bottom: 20px;
      }

      .learning-section h4 {
        margin: 0 0 8px;
        font-size: 14px;
        color: var(--accent);
      }

      .learning-section ul {
        margin: 0;
        padding-left: 16px;
        list-style: none;
      }

      .learning-section li {
        margin-bottom: 6px;
        font-size: 12px;
        line-height: 1.4;
      }

      .learning-section strong {
        color: var(--fg);
      }

      .learning-section p {
        margin: 0 0 10px;
        font-size: 12px;
        color: var(--muted);
      }

      .learning-section textarea {
        width: 100%;
        min-height: 120px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--card-2);
        color: var(--fg);
        padding: 10px;
        font-family: inherit;
        font-size: 12px;
        resize: vertical;
      }

      .learning-section textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .learning-mode .card {
        position: relative;
      }

      .learning-mode .card::after {
        content: "\1F4CA";
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--accent);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .learning-mode .card:hover::after,
      .learning-mode .card:focus-within::after {
        opacity: 1;
      }


      /* Learning Mode Indicators */
      .learning-mode .card {
        position: relative;
      }
      .learning-mode .card::after {
        content: "📊";
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--accent);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .learning-mode .card:hover::after {
        opacity: 1;
      }


      /* Onboarding Overlay */
      .onboarding-overlay {
        position: fixed;
        inset: 0;
        background: rgba(10, 12, 16, 0.92);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 300;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      .onboarding-overlay[hidden] {
        display: none;
      }
      .onboarding-modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 24px;
        box-shadow: 0 30px 70px rgba(0, 0, 0, 0.5);
        max-width: 600px;
        width: 100%;
        padding: 40px;
        position: relative;
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .onboarding-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: none;
        color: var(--muted);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        transition: var(--transition);
        display: grid;
        place-items: center;
      }
      .onboarding-close:hover {
        background: var(--card-2);
        color: var(--fg);
      }
      .onboarding-content {
        text-align: center;
      }
      .onboarding-icon {
        font-size: 48px;
        margin-bottom: 20px;
        animation: bounce 0.6s ease;
      }
      .onboarding-content h2 {
        margin: 0 0 16px 0;
        font-size: 28px;
        color: var(--fg);
      }
      .onboarding-content p {
        margin: 0 0 30px 0;
        color: var(--muted);
        font-size: 16px;
        line-height: 1.6;
      }
      .onboarding-features {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin: 30px 0;
        text-align: left;
      }
      .onboarding-feature {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        background: var(--card-2);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        transition: var(--transition);
      }
      .onboarding-feature:hover {
        border-color: var(--accent);
        transform: translateX(4px);
      }
      .onboarding-feature-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      .onboarding-feature-content h3 {
        margin: 0 0 4px 0;
        font-size: 16px;
        color: var(--fg);
      }
      .onboarding-feature-content p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
      }
      .onboarding-footer {
        display: flex;
        gap: 12px;
        margin-top: 30px;
        justify-content: center;
      }
      .onboarding-step-indicator {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin: 20px 0;
      }
      .onboarding-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--border);
        transition: var(--transition);
      }
      .onboarding-dot.active {
        background: var(--accent);
        width: 24px;
        border-radius: 4px;
      }
      .onboarding-help-icon {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        border: none;
        box-shadow: var(--shadow-hover);
        cursor: pointer;
        font-size: 24px;
        display: grid;
        place-items: center;
        z-index: 50;
        transition: var(--transition);
      }
      .onboarding-help-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
      }

      /* Skip Link */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: var(--accent);
        color: white;
        padding: 8px 16px;
        z-index: 1000;
        border-radius: 0 0 8px 0;
        font-weight: 600;
        text-decoration: none;
        transition: top 0.3s;
      }
      .skip-link:focus {
        top: 0;
        outline: 3px solid var(--accent-2);
        outline-offset: 2px;
      }

      /* Detail Modal */
      .detail-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 64px 16px;
        background: rgba(10, 12, 16, 0.78);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        z-index: 260;
        transition: opacity 0.25s ease;
      }
      .detail-overlay[hidden] {
        display: none;
      }
      .detail-modal {
        width: min(940px, 100%);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 24px;
        box-shadow: 0 28px 68px rgba(0, 0, 0, 0.45);
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 120px);
        position: relative;
        overflow: hidden;
        animation: detailEnter 0.35s ease;
      }
      .detail-close {
        position: absolute;
        top: 18px;
        right: 18px;
        background: var(--card-2);
        border: 1px solid var(--border);
        color: var(--muted);
        width: 36px;
        height: 36px;
        border-radius: 999px;
        font-size: 20px;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: var(--transition);
      }
      .detail-close:hover,
      .detail-close:focus-visible {
        background: var(--accent);
        color: #fff;
        border-color: transparent;
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
      }
      .detail-header {
        padding: 36px 36px 0 36px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .detail-header h2 {
        margin: 0;
        font-size: clamp(24px, 3.2vw, 32px);
        line-height: 1.2;
      }
      .detail-category {
        align-self: flex-start;
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: rgba(59, 130, 246, 0.16);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: var(--accent);
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 600;
      }
      .detail-domain {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .detail-body {
        display: grid;
        grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
        gap: 28px;
        padding: 28px 36px 36px;
        align-items: flex-start;
        overflow-y: auto;
      }
      .detail-media {
        margin: 0;
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid var(--border);
        background: var(--card-2);
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.3);
      }
      .detail-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .detail-copy {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }
      .detail-summary {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        color: var(--fg);
        line-height: 1.6;
      }
      .detail-blurb {
        font-size: 13px;
        line-height: 1.6;
        color: rgba(232, 234, 237, 0.85);
        background: rgba(59, 130, 246, 0.08);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: var(--radius-sm);
        padding: 16px 18px;
      }
      .detail-meta {
        display: grid;
        gap: 18px;
      }
      .detail-meta-group h3 {
        margin: 0 0 8px;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .detail-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .detail-chip {
        font-size: 11px;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--card-2);
        color: var(--fg);
        letter-spacing: 0.01em;
      }
      .detail-chip.technique {
        border-style: dashed;
      }
      .detail-empty {
        font-size: 12px;
        color: var(--muted);
      }
      .detail-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 20px 36px 32px;
        border-top: 1px solid var(--border);
        background: var(--card-2);
      }

      @keyframes detailEnter {
        from {
          opacity: 0;
          transform: translateY(28px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @media (max-width: 900px) {
        .detail-body {
          grid-template-columns: 1fr;
          padding: 24px;
        }
        .detail-header {
          padding: 28px 24px 0;
        }
        .detail-actions {
          padding: 20px 24px 28px;
        }
        .detail-modal {
          max-height: calc(100vh - 72px);
          border-radius: 16px;
        }
      }
    </style>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header role="banner">
      <div class="wrap hero">
        <div class="title">
          <div class="logo" aria-hidden="true"><span>DV</span></div>
          <div class="title-text">
            <h1>Data Visualization Dashboard Showcase</h1>
            <p class="subtitle">
              <span class="subtitle-count"
                ><strong id="siteCount">0</strong> dashboards curated</span
              >
              <span class="subtitle-detail"
                >A curated collection for municipal professionals seeking inspiration and best practices in data visualization and dashboard design.</span
              >
            </p>
          </div>
        </div>
        <nav class="controls" aria-label="Filter and search controls">
          <div class="control">
            🔎
            <input
              id="q"
              type="search"
              placeholder="Search title, domain, tags…"
              autocomplete="off"
              aria-label="Search dashboards"
            />
          </div>
          <select id="filterTag" title="Filter by tag" aria-label="Filter by category">
            <option value="all">All types</option>
          </select>
          <select
            id="roleSelect"
            title="Select learning perspective"
            aria-label="Select learning perspective"
          >
            <option value="student">Participant view</option>
            <option value="coach">Coach view</option>
          </select>
          <select id="sortBy" title="Sort">
            <option value="default">Sort: Default</option>
            <option value="title">Sort: Title (A→Z)</option>
            <option value="domain">Sort: Domain (A→Z)</option>
          </select>
          <button id="refresh" aria-label="Refresh dashboard descriptions">Refresh blurbs</button>
          <button id="toggleLearning" aria-label="Toggle learning mode">📚 Learning Mode</button>
        </nav>
      </div>
    </header>

    <main role="main" id="main-content">
      <div class="wrap">
        <div class="chips" id="chips" role="group" aria-label="Filter by tags">
          <!-- dynamic chip badges rendered here -->
        </div>

        <div class="grid" id="grid" aria-live="polite" aria-label="Dashboard cards">
          <!-- cards populated via JS -->
        </div>

        <p class="meta notice">
          Thumbnails are generated from public URLs using snapshot services.
          Blurbs are fetched automatically from each page’s readable content
          (proxied for CORS). If a site blocks snapshots or content, the card
          will fall back gracefully.
        </p>
        <p class="meta notice" id="learningTip">
          Tip: Enable 📚 Learning Mode to follow guided prompts and print a
          personal study guide.
        </p>

      </div>
    </main>

    <!-- Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay" hidden>
      <div class="onboarding-modal" role="dialog" aria-modal="true" aria-labelledby="onboardingTitle">
        <button id="onboardingClose" class="onboarding-close" aria-label="Close onboarding">×</button>
        <div class="onboarding-content" id="onboardingContent">
          <!-- Step 1: Welcome -->
          <div class="onboarding-step" data-step="1">
            <div class="onboarding-icon">📊</div>
            <h2 id="onboardingTitle">Welcome to Dashboard Showcase!</h2>
            <p>Discover 70+ real-world data visualization examples from municipalities, organizations, and data professionals around the web.</p>
            <div class="onboarding-step-indicator">
              <div class="onboarding-dot active"></div>
              <div class="onboarding-dot"></div>
              <div class="onboarding-dot"></div>
            </div>
            <div class="onboarding-footer">
              <button class="btn" id="onboardingSkip">Skip</button>
              <button class="btn primary" id="onboardingNext">Next →</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Onboarding Help Button -->
    <button id="onboardingHelp" class="onboarding-help-icon" aria-label="Show help" title="Show help tour">?</button>

    <div id="detailOverlay" class="detail-overlay" hidden>
      <article
        id="detailModal"
        class="detail-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="detailTitle"
        aria-describedby="detailSummary"
        tabindex="-1"
      >
        <button
          id="closeDetail"
          class="detail-close"
          type="button"
          aria-label="Close showcase details"
        >
          ×
        </button>
        <header class="detail-header">
          <span class="detail-category" id="detailCategory"></span>
          <h2 id="detailTitle"></h2>
          <p class="detail-domain">
            <span aria-hidden="true">🔗</span>
            <span id="detailDomain"></span>
          </p>
        </header>
        <section class="detail-body" id="detailBody">
          <figure class="detail-media">
            <img id="detailScreenshot" alt="" loading="lazy" decoding="async" />
          </figure>
          <div class="detail-copy">
            <p class="detail-summary" id="detailSummary"></p>
            <div class="detail-blurb" id="detailBlurb"></div>
            <div class="detail-meta">
              <div class="detail-meta-group">
                <h3>Focus tags</h3>
                <div class="detail-chips" id="detailTags"></div>
              </div>
              <div class="detail-meta-group">
                <h3>Techniques to watch</h3>
                <div class="detail-chips" id="detailTechniques"></div>
              </div>
            </div>
          </div>
        </section>
        <footer class="detail-actions">
          <a id="detailVisit" class="btn primary" target="_blank" rel="noopener"
            >Visit site ↗</a
          >
          <a id="detailOpen" class="btn" target="_blank" rel="noopener"
            >Open in new tab</a
          >
        </footer>
      </article>
    </div>

    <template id="learning-panel-template">
      <div class="learning-overlay" id="learningOverlay" hidden>
        <div
          class="learning-panel"
          id="learningPanel"
          role="dialog"
          aria-modal="true"
          aria-labelledby="learningPanelTitle"
          aria-describedby="learningPanelDescription"
          tabindex="-1"
        >
          <div class="learning-header">
            <h3 id="learningPanelTitle">📚 Data Visualization Learning Mode</h3>
            <button
              id="closeLearning"
              class="close-btn"
              type="button"
              aria-label="Close learning mode"
            >
              ×
            </button>
          </div>
          <div class="learning-content" id="learningPanelDescription">
            <div class="learning-actions">
              <button id="printChecklist" class="btn primary" type="button">
                🖨️ Print review guide
              </button>
            </div>
            <div id="checklistContent">
              <div class="learning-section">
                <h4>🎯 Review Rhythm</h4>
                <p>
                  Work through these steps every time you open one of the linked
                  exemplars.
                </p>
                <ul>
                  <li>
                    ☐ Name the stakeholder and decision this visualization
                    supports.
                  </li>
                  <li>
                    ☐ Summarize the promise: what prioritization question should
                    it answer?
                  </li>
                  <li>
                    ☐ Trace the data path: where do the scores, statuses, or
                    rankings originate?
                  </li>
                  <li>
                    ☐ Capture one idea worth stealing and one practice to avoid.
                  </li>
                </ul>
              </div>
              <div class="learning-section">
                <h4>🏙️ Public CIP Dashboards — Checklist</h4>
                <p>
                  Use municipal examples to evaluate how cities communicate
                  project pipelines.
                </p>
                <ul>
                  <li>
                    ☐ Are funding phases, timelines, and geography linked
                    clearly?
                  </li>
                  <li>
                    ☐ Does the map or table explain how priorities shift across
                    districts?
                  </li>
                  <li>
                    ☐ Where do residents see tradeoffs (cost vs. impact vs.
                    readiness)?
                  </li>
                  <li>
                    ☐ Is there a path to dig deeper—supporting docs, contact
                    info, or filters?
                  </li>
                </ul>
              </div>
              <div class="learning-section">
                <h4>🏢 Portfolio & Product Tools — Checklist</h4>
                <p>
                  Interrogate how vendors express scoring models you might adapt
                  internally.
                </p>
                <ul>
                  <li>
                    ☐ What criteria feed the scorecard, and can you trace the
                    weighting?
                  </li>
                  <li>
                    ☐ How does the interface show uncertainty, risk, or scenario
                    planning?
                  </li>
                  <li>
                    ☐ Are handoffs obvious—what happens after something ranks
                    highly?
                  </li>
                  <li>
                    ☐ Could Austin teams reuse the language without confusing
                    stakeholders?
                  </li>
                </ul>
              </div>
              <div class="learning-section">
                <h4>📊 Visualization Patterns & Power BI — Checklist</h4>
                <p>
                  Focus on the mechanics of charts, interactions, and
                  annotations.
                </p>
                <ul>
                  <li>
                    ☐ Does the layout guide the eye from question to insight to
                    action?
                  </li>
                  <li>
                    ☐ Are color scales, legends, and tooltips explicit about
                    what matters?
                  </li>
                  <li>
                    ☐ Is there a balance between overview metrics and detailed
                    evidence?
                  </li>
                  <li>
                    ☐ How are updates, refresh rates, or data lineage
                    communicated?
                  </li>
                </ul>
              </div>
              <div class="learning-section">
                <h4>🧠 Internal Monologue to Practice</h4>
                <p>
                  Adopt these prompts while scanning each dashboard or
                  visualization.
                </p>
                <ul>
                  <li>
                    “What story about priority is this view persuading me to
                    believe?”
                  </li>
                  <li>
                    “Which voices or datasets might be missing from this
                    narrative?”
                  </li>
                  <li>
                    “If I had to defend a decision with this dashboard, what
                    evidence is thin?”
                  </li>
                  <li>
                    “How would Austin leadership challenge or support what they
                    see here?”
                  </li>
                </ul>
              </div>
              <div class="learning-section">
                <h4>✍️ Field Notes</h4>
                <p>
                  Document phrasing, visual moves, or facilitation ideas you
                  want to reuse.
                </p>
                <textarea
                  id="reviewNotes"
                  placeholder="Capture observations, phrases, follow-up questions…"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <footer class="footer">
      <div class="wrap">
        <div>
          Static site, no tracking, no frameworks. Host on GitHub Pages.
        </div>
      </div>
    </footer>

    <script>
      // ======== Configuration loader ========
      const SITES_ENDPOINT = "sites.json";
      let sites = [];

      async function loadSites() {
        try {
          const res = await fetch(SITES_ENDPOINT, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          const items = Array.isArray(payload)
            ? payload
            : (payload && payload.sites) || [];
          if (!Array.isArray(items) || items.length === 0) {
            throw new Error("No sites found in configuration");
          }
          sites = items.map(normalizeSite);
          populateTagControls(sites);
          updateHeroSummary(sites.length);
          build();
          applyFilters();
        } catch (err) {
          console.error("Failed to load site configuration", err);
          showConfigError();
        }
      }

      function normalizeSite(site = {}) {
        const tags = Array.isArray(site.tags) ? site.tags.filter(Boolean) : [];
        if (tags.length === 0) tags.push("Uncategorized");
        return {
          title: site.title || "Untitled dashboard",
          url: site.url || "#",
          tags,
          description:
            typeof site.description === "string" ? site.description.trim() : "",
          techniques: Array.isArray(site.techniques)
            ? site.techniques.filter(Boolean)
            : [],
        };
      }

      function showConfigError() {
        updateHeroSummary(0);
        grid.innerHTML = `
        <article class="card">
          <section class="content">
            <h3>Unable to load showcase data</h3>
            <p class="blurb">Check that <code>${escapeHtml(SITES_ENDPOINT)}</code> is reachable and correctly formatted.</p>
          </section>
        </article>
      `;
      }

      // ======== Utility helpers ========

      const $ = (sel, el = document) => el.querySelector(sel);
      const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));

      const learningTemplate = document.getElementById(
        "learning-panel-template",
      );
      if (learningTemplate) {
        document.body.appendChild(learningTemplate.content.cloneNode(true));
        learningTemplate.remove();
      }

      const ROLE_STORAGE_KEY = "pp-showcase-role";
      const DEFAULT_ROLE = "student";
      const ROLE_CONTENT = {
        student: {
          tip: "Participant tip: open Learning Mode to follow guided prompts and print your personal study sheet.",
          buttonInactive: "📚 Participant Learning Mode",
          buttonActive: "📚 Exit Participant Mode",
          buttonAria: "Toggle participant learning mode overlay",
          printLabel: "🖨️ Print participant guide",
          printAria: "Print the participant review guide",
          printTitle: "Participant Review Guide",
          sections: [
            {
              title: "🎯 Study Rhythm",
              description:
                "Use this loop each time you explore a dashboard exemplar.",
              items: [
                "☐ Identify the audience and the single decision this view should unlock.",
                "☐ Summarize the prioritization story in one sentence—does the evidence back it up?",
                "☐ Trace each score or status back to its source; capture any data gaps.",
                "☐ Note one design move to reuse and one caveat to watch for in your own work.",
              ],
            },
            {
              title: "🏙️ Public CIP Dashboards — Participant Lens",
              description:
                "Look for signals that help residents and leaders understand capital tradeoffs.",
              items: [
                "☐ Map funding phases to timeline and geography to confirm equity of coverage.",
                "☐ Check whether project categories explain who benefits and when.",
                "☐ Observe how risk, delays, and budget pressure surface in the story.",
                "☐ List transparency cues you would expect if you were a community member.",
              ],
            },
            {
              title: "🏢 Portfolio & Product Tools — Participant Lens",
              description:
                "Study how product teams frame prioritization logic and scenario planning.",
              items: [
                "☐ Decode the scoring formula: inputs, weights, and refresh cadence.",
                "☐ Watch for signals about capacity, dependencies, or sequencing choices.",
                "☐ Evaluate how easy it is to compare options and spot tradeoffs quickly.",
                "☐ Translate jargon—could your teammates understand this framing without help?",
              ],
            },
            {
              title: "📊 Visualization Patterns & Power BI",
              description:
                "Pay attention to interaction design and the path from question to action.",
              items: [
                "☐ Follow the eye path—does the layout guide question → insight → action?",
                "☐ Test filters and tooltips to see if they reveal trustworthy context.",
                "☐ Evaluate color, legend, and annotation clarity for accessibility.",
                "☐ Check the view on smaller screens if responsiveness matters.",
              ],
            },
            {
              title: "🧠 Reflection Prompts",
              description:
                "Turn observations into experiments for your own coursework or projects.",
              items: [
                "• What surprised you about how this organization communicates priority?",
                "• Which chart, phrase, or scoring idea would improve your storytelling immediately?",
                "• Where would you ask for more evidence before making a decision?",
                "• What follow-up research or partner conversation does this exemplar spark?",
              ],
            },
          ],
          notes: {
            title: "✍️ Field Notes",
            description:
              "Capture observations, follow-up questions, and ideas to test with your team.",
            placeholder:
              "Capture observations, follow-up questions, next actions…",
          },
        },
        coach: {
          tip: "Coach tip: open Learning Mode to access facilitation checklists and a printable workshop playbook.",
          buttonInactive: "📚 Coach Playbook Mode",
          buttonActive: "📚 Exit Coach Mode",
          buttonAria: "Toggle coach learning mode overlay",
          printLabel: "🖨️ Print coach playbook",
          printAria: "Print the coaching workshop guide",
          printTitle: "Coaching Workshop Guide",
          sections: [
            {
              title: "🎯 Facilitation Rhythm",
              description:
                "Use this sequence when guiding teams through an exemplar.",
              items: [
                "☐ Clarify the session objective and the decision skill you are reinforcing.",
                "☐ Preview what good evidence looks like before the group explores the dashboard.",
                "☐ Surface blind spots by asking whose needs or tradeoffs are implied.",
                "☐ Close by translating insights into an experiment or commitment for the team.",
              ],
            },
            {
              title: "🏙️ Public CIP Dashboards — Coaching Focus",
              description:
                "Equip civic teams to communicate transparency and accountability.",
              items: [
                "☐ Compare budget, schedule, and geography—what must leaders explain in public?",
                "☐ Highlight how risk, delays, or equity tradeoffs appear (or fail to appear).",
                "☐ Capture questions residents, council members, or media would still ask.",
                "☐ Plan a follow-up artifact to extend the conversation after the workshop.",
              ],
            },
            {
              title: "🏢 Portfolio & Product Tools — Coaching Focus",
              description:
                "Model how to translate vendor frameworks into your organization’s language.",
              items: [
                "☐ Reverse-engineer the scoring rubric and align it with your portfolio taxonomy.",
                "☐ Demonstrate how to facilitate prioritization when data quality is uncertain.",
                "☐ Identify opportunities to add scenario planning or dependency mapping discussions.",
                "☐ Draft a prompt that ties metrics back to strategic outcomes for leadership.",
              ],
            },
            {
              title: "📊 Visualization Patterns — Workshop Callouts",
              description:
                "Prepare teaching moments that connect design choices to stakeholder impact.",
              items: [
                "☐ Spotlight design moves that make tradeoffs and risk unmistakable.",
                "☐ Offer an alternative framing if the chart over-promises certainty.",
                "☐ Note which visuals are easiest to repurpose for stakeholder briefings.",
                "☐ Flag accessibility gaps your teams should avoid when templating dashboards.",
              ],
            },
            {
              title: "🧠 Coaching Prompts",
              description:
                "Guide facilitators as they adapt the exemplar to their teams.",
              items: [
                "• How will you adapt this exemplar for a live working session?",
                "• Where might teams misinterpret the scoring story without facilitation?",
                "• Which partners or datasets must you involve to mirror this level of rigor?",
                "• What follow-on assignment keeps momentum after the workshop?",
              ],
            },
          ],
          notes: {
            title: "🗂️ Facilitation Plan",
            description:
              "Outline logistics, owners, and follow-ups for your coaching sessions.",
            placeholder:
              "Outline facilitation moves, owners, and follow-up actions…",
          },
        },
      };

      function getRoleConfig(role) {
        return ROLE_CONTENT[role] || ROLE_CONTENT[DEFAULT_ROLE];
      }

      function renderLearningSections(config) {
        const container = $("#checklistContent");
        if (!container) return;
        container.innerHTML = "";

        config.sections.forEach((section) => {
          const sectionEl = document.createElement("div");
          sectionEl.className = "learning-section";

          const heading = document.createElement("h4");
          heading.textContent = section.title;
          sectionEl.appendChild(heading);

          if (section.description) {
            const para = document.createElement("p");
            para.textContent = section.description;
            sectionEl.appendChild(para);
          }

          if (Array.isArray(section.items) && section.items.length) {
            const list = document.createElement("ul");
            section.items.forEach((item) => {
              const li = document.createElement("li");
              li.textContent = item;
              list.appendChild(li);
            });
            sectionEl.appendChild(list);
          }

          container.appendChild(sectionEl);
        });

        if (config.notes) {
          const notesSection = document.createElement("div");
          notesSection.className = "learning-section";

          const heading = document.createElement("h4");
          heading.textContent = config.notes.title;
          notesSection.appendChild(heading);

          if (config.notes.description) {
            const para = document.createElement("p");
            para.textContent = config.notes.description;
            notesSection.appendChild(para);
          }

          const textarea = document.createElement("textarea");
          textarea.id = "reviewNotes";
          textarea.placeholder = config.notes.placeholder || "";
          notesSection.appendChild(textarea);

          container.appendChild(notesSection);
        }
      }

      const NOTES_KEY = "pp-showcase-notes";

      function setupNotesPersistence() {
        const notesEl = $("#reviewNotes");
        if (!notesEl) return;
        const storageKey = `${NOTES_KEY}-${currentRole}`;
        notesEl.value = localStorage.getItem(storageKey) || "";
        notesEl.addEventListener("input", () => {
          localStorage.setItem(storageKey, notesEl.value);
        });
      }

      function renderRole(role, learningModeActive) {
        const config = getRoleConfig(role);
        const tip = $("#learningTip");
        if (tip) tip.textContent = config.tip;

        if (printChecklistBtn) {
          printChecklistBtn.textContent =
            config.printLabel || printChecklistBtn.textContent;
          if (config.printAria) {
            printChecklistBtn.setAttribute("aria-label", config.printAria);
          }
        }

        renderLearningSections(config);
        setupNotesPersistence();
        setLearningButtonState(learningModeActive);
      }

      function setLearningButtonState(active) {
        if (!learningBtn) return;
        const config = getRoleConfig(currentRole);
        const inactiveLabel = config.buttonInactive || "📚 Learning Mode";
        const activeLabel = config.buttonActive || "📚 Exit Learning Mode";
        learningBtn.textContent = active ? activeLabel : inactiveLabel;
        if (config.buttonAria) {
          learningBtn.setAttribute("aria-label", config.buttonAria);
        }
        learningBtn.setAttribute("aria-expanded", String(active));
      }

      const hostname = (url) => {
        try {
          return new URL(url).hostname.replace(/^www\./, "");
        } catch {
          return url;
        }
      };

      const screenshotURL = (url, width = 640) =>
        `https://s.wordpress.com/mshots/v1/${encodeURIComponent(url)}?w=${width}`;

      const screenshotFallback = (url) =>
        `https://image.thum.io/get/width/1200/crop/900/${url}`;

      const faviconURL = (url) => {
        const host = hostname(url);
        return `https://www.google.com/s2/favicons?domain=${host}&sz=256`;
      };

      const proxiedReadableURL = (url) => {
        // Use Jina reader proxy to bypass CORS and get readable content
        const clean = url.replace(/^https?:\/\//, "");
        return `https://r.jina.ai/http://${clean}`;
      };

      const truncate = (s, n = 260) =>
        s && s.length > n ? s.slice(0, n - 1) + "…" : s || "";

      function createChip(tagText) {
        const chip = document.createElement("button");
        chip.className = "chip";
        chip.textContent = tagText;
        chip.type = "button";
        chip.dataset.tag = tagText;
        chip.setAttribute("aria-pressed", "false");
        chip.addEventListener("click", () => {
          const pressed = chip.getAttribute("aria-pressed") === "true";
          chip.setAttribute("aria-pressed", String(!pressed));
          applyFilters();
        });
        return chip;
      }

      // ======== Build UI ========
      const grid = $("#grid");
      const chipsWrap = $("#chips");
      const siteCountEl = $("#siteCount");

      function populateTagControls(items) {
        chipsWrap.innerHTML = "";
        filterTag.innerHTML = "";

        const allOption = document.createElement("option");
        allOption.value = "all";
        allOption.textContent = "All types";
        filterTag.appendChild(allOption);

        const tags = Array.from(
          new Set(items.flatMap((site) => site.tags || [])),
        ).sort((a, b) => a.localeCompare(b));

        tags.forEach((tag) => {
          chipsWrap.appendChild(createChip(tag));
          const option = document.createElement("option");
          option.value = tag;
          option.textContent = tag;
          filterTag.appendChild(option);
        });

        filterTag.value = "all";
      }

      function updateHeroSummary(totalSites = 0) {
        if (siteCountEl) {
          siteCountEl.textContent = Number.isFinite(totalSites)
            ? String(totalSites)
            : "0";
        }
      }

      function cardTemplate(item) {
        const host = hostname(item.url);
        const elm = document.createElement("article");
        elm.className = "card loading";
        elm.dataset.tags = (item.tags || []).join("|").toLowerCase();
        elm.dataset.title = (item.title || "").toLowerCase();
        elm.dataset.domain = host.toLowerCase();
        elm.setAttribute("role", "article");
        elm.setAttribute("tabindex", "0");

        // Add click handler for compare mode
        elm.addEventListener("click", (e) => {
          if (
            !e.target.closest(".btn") &&
            !e.target.closest(".tag") &&
            !e.target.closest(".technique-tag")
          ) {
            handleCardClick(elm, item, e);
          }
        });
        elm.addEventListener("keydown", (event) => {
          if (
            (event.key === "Enter" || event.key === " ") &&
            !event.target.closest(".btn") &&
            !event.target.closest(".tag") &&
            !event.target.closest(".technique-tag")
          ) {
            event.preventDefault();
            handleCardClick(elm, item, event);
          }
        });

        const primaryTag = item.tags[0] || "Uncategorized";
        const categoryIcon = getCategoryIcon(primaryTag);
        const categoryAria = getCategoryAria(primaryTag);
        const headingId = `card-title-${Math.random().toString(36).slice(2, 9)}`;
        const description = escapeHtml(
          item.description || "Loading description...",
        );

        elm.innerHTML = `
        <header class="card-header">
          <span class="category-badge" aria-label="${categoryAria}">
            <span aria-hidden="true">${categoryIcon}</span>
            ${escapeHtml(primaryTag)}
          </span>
          <span class="domain" aria-label="Domain: ${host}">${host}</span>
        </header>
        
        <div class="thumb" role="img" aria-label="Screenshot of ${escapeHtml(item.title)}">
          <img alt="" loading="lazy" decoding="async" data-src="${screenshotURL(item.url)}">
          <div class="pattern-overlay" aria-hidden="true">
            ${
              item.techniques.length
                ? item.techniques
                    .slice(0, 3)
                    .map(
                      (t) =>
                        `<span class="technique-badge">${escapeHtml(t)}</span>`,
                    )
                    .join("")
                : ""
            }
          </div>
          <span class="badge">${host}</span>
        </div>
        
        <section class="content">
          <h3 id="${headingId}">${escapeHtml(item.title)}</h3>
          <p class="blurb">${description}</p>
          ${
            item.techniques.length
              ? `
            <div class="techniques" aria-label="Key techniques demonstrated">
              ${item.techniques
                .map(
                  (t) => `<span class="technique-tag">${escapeHtml(t)}</span>`,
                )
                .join("")}
            </div>
          `
              : ""
          }
        </section>
        
        <footer class="actions">
          <a class="btn primary" href="${item.url}" target="_blank" rel="noopener" 
             aria-describedby="${headingId}">Visit site ↗</a>
          <a class="btn" href="${item.url}" target="_blank" rel="noopener"
             aria-describedby="${headingId}">Open in new tab</a>
        </footer>
      `;
        return elm;
      }

      function renderDetailChips(container, items, variant) {
        if (!container) return;
        container.innerHTML = "";
        if (!Array.isArray(items) || items.length === 0) {
          const empty = document.createElement("span");
          empty.className = "detail-empty";
          empty.textContent =
            variant === "technique"
              ? "Techniques will appear as annotations are added."
              : "Tags will populate soon.";
          container.appendChild(empty);
          return;
        }
        items.forEach((value) => {
          if (!value) return;
          const chip = document.createElement("span");
          chip.className = `detail-chip${variant === "technique" ? " technique" : ""}`;
          chip.textContent = value;
          container.appendChild(chip);
        });
      }

      function focusDetailFirst() {
        if (!detailOverlay) return;
        const focusable = $$(focusableSelector, detailOverlay).filter(
          (el) =>
            !el.hasAttribute("disabled") &&
            el.getAttribute("tabindex") !== "-1" &&
            el.getAttribute("aria-hidden") !== "true",
        );
        const target = focusable[0] || detailModal;
        if (target && typeof target.focus === "function") {
          target.focus();
        }
      }

      function handleDetailKeydown(event) {
        if (!detailOverlay || detailOverlay.hidden) return;
        if (event.key === "Escape") {
          event.preventDefault();
          closeDetailModal();
          return;
        }
        if (event.key !== "Tab") return;

        const focusable = $$(focusableSelector, detailOverlay).filter(
          (el) =>
            !el.hasAttribute("disabled") &&
            el.getAttribute("aria-hidden") !== "true",
        );

        if (focusable.length === 0) {
          event.preventDefault();
          if (detailModal && typeof detailModal.focus === "function") {
            detailModal.focus();
          }
          return;
        }

        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        const current = document.activeElement;

        if (event.shiftKey && current === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && current === last) {
          event.preventDefault();
          first.focus();
        }
      }

      function openDetailModal(item, card) {
        if (!detailOverlay || !detailModal) return;
        detailLastFocused =
          document.activeElement instanceof HTMLElement
            ? document.activeElement
            : null;

        const primaryTag =
          Array.isArray(item.tags) && item.tags.length
            ? item.tags[0]
            : "Uncategorized";
        const icon = getCategoryIcon(primaryTag);
        if (detailCategory) {
          detailCategory.textContent = `${icon ? `${icon} ` : ""}${primaryTag}`;
        }

        if (detailTitle) {
          detailTitle.textContent = item.title || "Untitled dashboard";
        }

        const domainText = hostname(item.url);
        if (detailDomain) {
          detailDomain.textContent = domainText;
        }

        if (detailSummaryText) {
          const summary =
            item.description && item.description.trim().length
              ? item.description
              : "Curator notes will populate soon.";
          detailSummaryText.textContent = summary;
        }

        if (detailBlurb) {
          const blurbNode = card ? card.querySelector(".blurb") : null;
          const blurbText = blurbNode ? blurbNode.textContent.trim() : "";
          detailBlurb.textContent =
            blurbText ||
            "Live summary will load once site content is retrieved.";
        }

        renderDetailChips(detailTags, item.tags, "tag");
        renderDetailChips(detailTechniques, item.techniques, "technique");

        if (detailVisit) detailVisit.href = item.url || "#";
        if (detailOpen) detailOpen.href = item.url || "#";

        if (detailScreenshot) {
          const cardImg = card ? card.querySelector(".thumb img") : null;
          const candidateSrc =
            cardImg && cardImg.src && cardImg.src.length
              ? cardImg.src
              : screenshotURL(item.url, 1200);
          detailScreenshot.src = candidateSrc;
          detailScreenshot.alt = `Screenshot of ${item.title}`;
        }

        if (detailBody) {
          if (typeof detailBody.scrollTo === "function") {
            detailBody.scrollTo({ top: 0, behavior: "auto" });
          } else {
            detailBody.scrollTop = 0;
          }
        }

        detailOverlay.hidden = false;
        document.body.classList.add("detail-open");
        focusDetailFirst();
        document.addEventListener("keydown", handleDetailKeydown);
      }

      function closeDetailModal() {
        if (!detailOverlay || detailOverlay.hidden) return;
        detailOverlay.hidden = true;
        document.body.classList.remove("detail-open");
        document.removeEventListener("keydown", handleDetailKeydown);
        if (
          detailLastFocused &&
          typeof detailLastFocused.focus === "function"
        ) {
          detailLastFocused.focus();
        }
        detailLastFocused = null;
      }

      function getCategoryIcon(tag) {
        const icons = {
          "Public CIP": "🏛️",
          "Power BI": "📊",
          "Portfolio Management": "💼",
          "Visualization Patterns": "✨",
          "Resource Recovery": "♻️",
          "Zero Waste": "♻️",
          "C&D Waste": "🏗️",
          "Green Halo": "🟢",
          "Policy Reference": "📑",
          Guidance: "🧭",
          "International Benchmark": "🌍",
          "National Policy": "🏛️",
          "Reference Data": "📓",
          "Municipal Program": "🏙️",
        };
        return icons[tag] || "📊";
      }

      function getCategoryAria(tag) {
        return `Category: ${tag}`;
      }

      function build(data = sites) {
        grid.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          grid.innerHTML =
            '<p class="meta notice">No dashboards configured yet.</p>';
          return;
        }
        data.forEach((item, index) => {
          const card = cardTemplate(item);
          card.style.setProperty("--index", index);
          grid.appendChild(card);
        });
        setupLazyImages();
      }

      // ======== Blurbs (with caching) ========
      const CACHE_KEY = "pp-showcase-blurbs-v1";
      const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}");

      function saveCache() {
        localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
      }

      async function fetchBlurb(url) {
        // Try cache first
        const cached = cache[url];
        if (
          cached &&
          cached.text &&
          Date.now() - cached.ts < 1000 * 60 * 60 * 24 * 7
        ) {
          // 7 days
          return cached.text;
        }
        try {
          const res = await fetch(proxiedReadableURL(url), { mode: "cors" });
          if (!res.ok) throw new Error("bad status");
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, "text/html");
          // Prefer first reasonable <p>
          let text = "";
          const ps = Array.from(doc.querySelectorAll("p"))
            .map((p) => (p.textContent || "").trim())
            .filter(
              (t) =>
                t.split(/\s+/).length >= 10 &&
                !/cookie|javascript|enable|subscribe|sign in|accept/i.test(t),
            );
          if (ps.length) text = ps[0];
          if (!text) {
            // fallback: first long text node from body
            const raw = ((doc.body && doc.body.textContent) || "").trim();
            const candidate = raw
              .split(/\n{2,}/)
              .find((s) => s.trim().length > 80);
            text = candidate || "";
          }
          text = truncate(text, 280);
          if (text) {
            cache[url] = { text, ts: Date.now() };
            saveCache();
          }
          return text;
        } catch (e) {
          return "";
        }
      }

      async function hydrateBlurbs(onProgress) {
        const cards = $$(".card");
        const total = cards.length;
        for (let i = 0; i < cards.length; i++) {
          const card = cards[i];
          const url = $(".btn.primary", card).getAttribute("href");
          const blurbEl = $(".blurb", card);
          const text = await fetchBlurb(url);
          if (text) {
            blurbEl.textContent = text;
          } else {
            blurbEl.innerHTML =
              '<span class="notice">Blurb unavailable (site blocked or no readable text).</span>';
          }
          if (onProgress) onProgress(i + 1, total);
        }
      }

      // ======== Lazy-load screenshots with fallbacks ========
      function setupLazyImages() {
        const imgs = $$("img[data-src]");
        const io = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                const card = img.closest(".card");
                img.src = img.dataset.src;
                img.addEventListener("load", () => {
                  img.classList.add("loaded");
                  if (card) card.classList.remove("loading");
                });
                img.addEventListener("error", () => {
                  // Fallback chain: thum.io → favicon
                  img.onerror = () => {
                    img.src = faviconURL(
                      img.closest(".card").querySelector(".btn.primary").href,
                    );
                    if (card) card.classList.remove("loading");
                  };
                  img.src = screenshotFallback(
                    img.closest(".card").querySelector(".btn.primary").href,
                  );
                });
                io.unobserve(img);
              }
            });
          },
          { rootMargin: "200px" },
        );
        imgs.forEach((img) => io.observe(img));
      }

      // ======== Search, filter, sort ========
      const q = $("#q");
      const filterTag = $("#filterTag");
      const sortBy = $("#sortBy");
      const refreshBtn = $("#refresh");
      const learningBtn = $("#toggleLearning");
      const learningOverlay = $("#learningOverlay");
      const learningPanel = $("#learningPanel");
      const closeLearning = $("#closeLearning");
      const printChecklistBtn = $("#printChecklist");
      const checklistContent = $("#checklistContent");
      const roleSelect = $("#roleSelect");
      const detailOverlay = $("#detailOverlay");
      const detailModal = $("#detailModal");
      const detailClose = $("#closeDetail");
      const detailTitle = $("#detailTitle");
      const detailDomain = $("#detailDomain");
      const detailSummaryText = $("#detailSummary");
      const detailBlurb = $("#detailBlurb");
      const detailTags = $("#detailTags");
      const detailTechniques = $("#detailTechniques");
      const detailVisit = $("#detailVisit");
      const detailOpen = $("#detailOpen");
      const detailScreenshot = $("#detailScreenshot");
      const detailCategory = $("#detailCategory");
      const detailBody = $("#detailBody");

      // State management
      let learningMode = false;
      let lastFocusedElement = null;
      let detailLastFocused = null;
      let currentRole = localStorage.getItem(ROLE_STORAGE_KEY) || DEFAULT_ROLE;
      if (!ROLE_CONTENT[currentRole]) currentRole = DEFAULT_ROLE;

      const focusableSelector =
        'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';

      if (roleSelect) {
        roleSelect.value = currentRole;
        roleSelect.addEventListener("change", (event) => {
          const nextRole = event.target.value;
          currentRole = ROLE_CONTENT[nextRole] ? nextRole : DEFAULT_ROLE;
          localStorage.setItem(ROLE_STORAGE_KEY, currentRole);
          renderRole(currentRole, learningMode);
        });
      }

      renderRole(currentRole, learningMode);

      const focusFirstElement = () => {
        if (!learningOverlay) return;
        const focusable = $$(focusableSelector, learningOverlay).filter(
          (el) =>
            !el.hasAttribute("disabled") &&
            el.getAttribute("tabindex") !== "-1" &&
            el.getAttribute("aria-hidden") !== "true",
        );
        const target = focusable[0] || learningPanel;
        if (target && typeof target.focus === "function") {
          target.focus();
        }
      };

      const handleLearningKeydown = (event) => {
        if (!learningMode || !learningOverlay) return;
        if (event.key === "Escape") {
          event.preventDefault();
          closeLearningPanel();
          return;
        }
        if (event.key !== "Tab") return;

        const focusable = $$(focusableSelector, learningOverlay).filter(
          (el) =>
            !el.hasAttribute("disabled") &&
            el.getAttribute("aria-hidden") !== "true",
        );

        if (focusable.length === 0) {
          event.preventDefault();
          if (learningPanel) learningPanel.focus();
          return;
        }

        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        const current = document.activeElement;

        if (event.shiftKey && current === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && current === last) {
          event.preventDefault();
          first.focus();
        }
      };

      const openLearningPanel = () => {
        if (!learningOverlay || !learningPanel) return;
        learningMode = true;
        learningOverlay.hidden = false;
        document.body.classList.add("learning-mode");
        lastFocusedElement =
          document.activeElement instanceof HTMLElement
            ? document.activeElement
            : null;
        focusFirstElement();
        document.addEventListener("keydown", handleLearningKeydown);
        setLearningButtonState(true);
      };

      const closeLearningPanel = () => {
        if (!learningOverlay || !learningPanel) return;
        learningMode = false;
        learningOverlay.hidden = true;
        document.body.classList.remove("learning-mode");
        document.removeEventListener("keydown", handleLearningKeydown);
        setLearningButtonState(false);
        if (
          lastFocusedElement &&
          typeof lastFocusedElement.focus === "function"
        ) {
          lastFocusedElement.focus();
        } else if (learningBtn) {
          learningBtn.focus();
        }
        lastFocusedElement = null;
      };

      if (learningBtn) {
        learningBtn.setAttribute("aria-haspopup", "dialog");
        learningBtn.setAttribute("aria-expanded", "false");
        learningBtn.setAttribute("aria-controls", "learningPanel");
        learningBtn.addEventListener("click", () => {
          learningMode ? closeLearningPanel() : openLearningPanel();
        });
        setLearningButtonState(false);
      }

      if (closeLearning) {
        closeLearning.addEventListener("click", () => {
          closeLearningPanel();
        });
      }

      if (learningOverlay) {
        learningOverlay.addEventListener("mousedown", (event) => {
          if (event.target === learningOverlay) {
            closeLearningPanel();
          }
        });
      }

      if (detailClose) {
        detailClose.addEventListener("click", () => {
          closeDetailModal();
        });
      }

      if (detailOverlay) {
        detailOverlay.addEventListener("mousedown", (event) => {
          if (event.target === detailOverlay) {
            closeDetailModal();
          }
        });
      }

      if (printChecklistBtn && checklistContent) {
        printChecklistBtn.addEventListener("click", () => {
          const config = getRoleConfig(currentRole);
          const win = window.open("", "_blank");
          if (!win) return;
          const printable = checklistContent.cloneNode(true);
          const textarea = printable.querySelector("textarea");
          const notesField = $("#reviewNotes");
          const notesValue = notesField ? notesField.value : "";
          if (textarea) {
            const notesHeading = config.notes
              ? config.notes.title
              : "Field Notes";
            const safeNotes = notesValue
              ? escapeHtml(notesValue).replace(/\\n/g, "<br>")
              : "&nbsp;";
            const notesContainer = document.createElement("div");
            notesContainer.innerHTML = `<p><strong>${escapeHtml(notesHeading)}</strong></p><div class='notes'>${safeNotes}</div>`;
            textarea.replaceWith(notesContainer);
          }
          const printableTitle =
            config.printTitle || "Prioritization Visualization Review Guide";
          win.document
            .write(`<!DOCTYPE html><html><head><title>${escapeHtml(printableTitle)}</title>
          <style>
            body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:40px; color:#1f2937;}
            h1{font-size:22px; margin-bottom:12px;}
            h4{margin:24px 0 8px; font-size:16px; color:#111827;}
            ul{margin:0 0 12px 20px; padding:0;}
            li{margin-bottom:6px; font-size:13px; line-height:1.4;}
            p{font-size:13px; color:#4b5563; margin:0 0 12px;}
            .notes{border:1px solid #d1d5db; border-radius:8px; padding:12px; min-height:160px;}
          </style>
        </head><body>
          <h1>${escapeHtml(printableTitle)}</h1>
          ${printable.innerHTML}
        </body></html>`);
          win.document.close();
          win.focus();
          win.print();
        });
      }

      // Card click functionality
      function handleCardClick(card, item, evt) {
        if (evt && typeof evt.preventDefault === "function") {
          evt.preventDefault();
        }
        openDetailModal(item, card);
      }

      function applyFilters() {
        const query = q.value.trim().toLowerCase();
        const selectTag = filterTag.value;
        const pressedChips = $$('.chip[aria-pressed="true"]').map(
          (c) => c.dataset.tag,
        );

        const cards = $$(".card");
        cards.forEach((card) => {
          const title = card.dataset.title;
          const domain = card.dataset.domain;
          const tags = card.dataset.tags.split("|").filter(Boolean);

          const matchesQuery =
            !query ||
            title.includes(query) ||
            domain.includes(query) ||
            tags.some((t) => t.includes(query));
          const matchesSelect =
            selectTag === "all" || tags.includes(selectTag.toLowerCase());
          const matchesChips =
            pressedChips.length === 0 ||
            pressedChips.every((t) => tags.includes(t.toLowerCase()));

          card.style.display =
            matchesQuery && matchesSelect && matchesChips ? "" : "none";
        });

        // Sorting
        const visibleCards = $$(".card").filter(
          (c) => c.style.display !== "none",
        );
        const container = grid;
        const key = sortBy.value;
        if (key !== "default") {
          visibleCards.sort((a, b) => {
            if (key === "title")
              return a.dataset.title.localeCompare(b.dataset.title);
            if (key === "domain")
              return a.dataset.domain.localeCompare(b.dataset.domain);
            return 0;
          });
          visibleCards.forEach((c) => container.appendChild(c));
        }
      }

      q.addEventListener("input", applyFilters);
      filterTag.addEventListener("change", applyFilters);
      sortBy.addEventListener("change", applyFilters);
      refreshBtn.addEventListener("click", async () => {
        // Clear cache and re-hydrate
        localStorage.removeItem(CACHE_KEY);
        Object.keys(cache).forEach((k) => delete cache[k]);

        const originalText = refreshBtn.textContent;
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '⏳ Refreshing... <span class="progress-count">0/0</span>';

        await hydrateBlurbs((current, total) => {
          const progressSpan = refreshBtn.querySelector('.progress-count');
          if (progressSpan) {
            progressSpan.textContent = `${current}/${total}`;
          }
        });

        refreshBtn.innerHTML = '✓ Refreshed!';
        setTimeout(() => {
          refreshBtn.textContent = originalText;
          refreshBtn.disabled = false;
        }, 2000);
      });

      // ======== HTML escape helper ========
      function escapeHtml(s = "") {
        return s.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[m],
        );
      }

      // ======== Onboarding Flow ========
      const onboardingOverlay = $("#onboardingOverlay");
      const onboardingContent = $("#onboardingContent");
      const onboardingClose = $("#onboardingClose");
      const onboardingHelp = $("#onboardingHelp");
      const ONBOARDING_KEY = "hasSeenOnboarding";
      let currentStep = 1;

      const onboardingSteps = [
        {
          icon: "🏛️",
          title: "Welcome, Data Practitioners!",
          description: "Discover how municipalities and organizations worldwide are visualizing complex data to inform decisions, engage communities, and tell compelling stories. This curated collection features 70+ real-world examples—from capital improvement programs to resource recovery dashboards—designed to inspire your next project.",
        },
        {
          icon: "🔍",
          title: "Research, Compare, Learn",
          description: "Designed for municipal workers, analysts, and coaches who want to see how peers are solving similar data challenges.",
          features: [
            {
              icon: "📚",
              title: "Learning Mode",
              description: "Get guided prompts and create a personal study guide"
            },
            {
              icon: "🔍",
              title: "Smart Filters",
              description: "Filter by tags, categories, and visualization techniques"
            },
            {
              icon: "🎯",
              title: "Detailed Analysis",
              description: "Click any dashboard for in-depth information and insights"
            }
          ]
        },
        {
          icon: "💡",
          title: "Find Your Inspiration",
          description: "Whether you're building a CIP tracker, performance dashboard, or community engagement tool—explore how others have approached similar challenges. Click any example to dive deeper, or use filters to find dashboards relevant to your work.",
        }
      ];

      function showOnboarding() {
        if (!onboardingOverlay) return;
        currentStep = 1;
        renderOnboardingStep(1);
        onboardingOverlay.hidden = false;
        document.body.style.overflow = "hidden";
      }

      function hideOnboarding(markAsSeen = true) {
        if (!onboardingOverlay) return;
        onboardingOverlay.hidden = true;
        document.body.style.overflow = "";
        if (markAsSeen) {
          localStorage.setItem(ONBOARDING_KEY, "true");
        }
      }

      function renderOnboardingStep(step) {
        if (!onboardingContent) return;
        const stepData = onboardingSteps[step - 1];
        if (!stepData) return;

        let html = `
          <div class="onboarding-step" data-step="${step}">
            <div class="onboarding-icon">${stepData.icon}</div>
            <h2>${stepData.title}</h2>
            <p>${stepData.description}</p>
        `;

        if (stepData.features) {
          html += '<div class="onboarding-features">';
          stepData.features.forEach(feature => {
            html += `
              <div class="onboarding-feature">
                <div class="onboarding-feature-icon">${feature.icon}</div>
                <div class="onboarding-feature-content">
                  <h3>${feature.title}</h3>
                  <p>${feature.description}</p>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }

        html += '<div class="onboarding-step-indicator">';
        for (let i = 1; i <= onboardingSteps.length; i++) {
          html += `<div class="onboarding-dot ${i === step ? 'active' : ''}"></div>`;
        }
        html += '</div>';

        html += '<div class="onboarding-footer">';
        if (step > 1) {
          html += '<button class="btn" id="onboardingPrev">← Back</button>';
        }
        if (step < onboardingSteps.length) {
          html += '<button class="btn" id="onboardingSkip">Skip</button>';
          html += '<button class="btn primary" id="onboardingNext">Next →</button>';
        } else {
          html += '<button class="btn primary" id="onboardingStart">Get Started!</button>';
        }
        html += '</div></div>';

        onboardingContent.innerHTML = html;
        attachOnboardingListeners();
      }

      function attachOnboardingListeners() {
        const nextBtn = $("#onboardingNext");
        const prevBtn = $("#onboardingPrev");
        const skipBtn = $("#onboardingSkip");
        const startBtn = $("#onboardingStart");

        if (nextBtn) {
          nextBtn.addEventListener("click", () => {
            currentStep++;
            renderOnboardingStep(currentStep);
          });
        }

        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            currentStep--;
            renderOnboardingStep(currentStep);
          });
        }

        if (skipBtn) {
          skipBtn.addEventListener("click", () => {
            hideOnboarding(true);
          });
        }

        if (startBtn) {
          startBtn.addEventListener("click", () => {
            hideOnboarding(true);
          });
        }
      }

      if (onboardingClose) {
        onboardingClose.addEventListener("click", () => {
          hideOnboarding(true);
        });
      }

      if (onboardingHelp) {
        onboardingHelp.addEventListener("click", () => {
          showOnboarding();
        });
      }

      if (onboardingOverlay) {
        onboardingOverlay.addEventListener("mousedown", (event) => {
          if (event.target === onboardingOverlay) {
            hideOnboarding(true);
          }
        });
      }

      // Show onboarding on first visit
      if (!localStorage.getItem(ONBOARDING_KEY)) {
        setTimeout(() => showOnboarding(), 500);
      }

      // ======== Keyboard Navigation ========
      if (grid) {
        grid.addEventListener("keydown", (e) => {
          if (!["ArrowRight", "ArrowLeft", "ArrowDown", "ArrowUp"].includes(e.key)) {
            return;
          }

          const cards = Array.from(grid.querySelectorAll(".card")).filter(
            card => card.style.display !== "none"
          );
          const currentIndex = cards.indexOf(document.activeElement);

          if (currentIndex === -1) return;

          // Calculate grid columns
          const gridStyle = window.getComputedStyle(grid);
          const gridColumns = gridStyle.gridTemplateColumns.split(" ").length;

          let nextIndex = currentIndex;

          if (e.key === "ArrowRight" && currentIndex < cards.length - 1) {
            nextIndex = currentIndex + 1;
          } else if (e.key === "ArrowLeft" && currentIndex > 0) {
            nextIndex = currentIndex - 1;
          } else if (e.key === "ArrowDown") {
            nextIndex = Math.min(currentIndex + gridColumns, cards.length - 1);
          } else if (e.key === "ArrowUp") {
            nextIndex = Math.max(currentIndex - gridColumns, 0);
          }

          if (nextIndex !== currentIndex && cards[nextIndex]) {
            e.preventDefault();
            cards[nextIndex].focus();
            cards[nextIndex].scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        });
      }

      // ======== Init ========
      loadSites();
    </script>
  </body>
</html>
